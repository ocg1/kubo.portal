package mx.com.kubo.managedbeans;

import java.io.Serializable;
import java.util.Date;

import sun.misc.BASE64Decoder;
import sun.misc.BASE64Encoder;


import javax.annotation.PostConstruct;
import javax.el.ELContext;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ManagedProperty;
import javax.faces.bean.ViewScoped;
import javax.faces.context.FacesContext;

import mx.com.kubo.model.Access;
import mx.com.kubo.model.Scoring;
import mx.com.kubo.services.AccessService;
import mx.com.kubo.services.ScoringService;
import mx.com.kubo.tools.Utilities;



@ManagedBean
@ViewScoped
public class EFL_Redirec implements Serializable {

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	
	@ManagedProperty("#{scoringServiceImp}")
	protected ScoringService scoringservice;
	
	@ManagedProperty("#{accessServiceImp}")
	protected AccessService accessService;
	
	private String url_str_1;
	private String url_redirec;
	private String url_str_2;
	
	@PostConstruct
	public void init(){
		
		FacesContext facesContext = FacesContext.getCurrentInstance();
		
		ELContext elContext = facesContext.getELContext();
		SessionBean sesion = (SessionBean) FacesContext.getCurrentInstance()
				.getApplication().getELResolver()
				.getValue(elContext, null, "sessionBean");
		
		generaURL( sesion.getProspectus_id() +"" );
		
		actualizaViewScreen( sesion );
		
	}
	
	private void actualizaViewScreen( SessionBean sesion ){
		
		Scoring score = scoringservice.loadMaxScoringByProspectus(sesion.getProspectus_id(), sesion.getCompany_id());
		
		score.setScreen_viewed(1);
		
		scoringservice.updateScoring(score);
		
		Access accessTmp = accessService.getMaxAccess(sesion.getProspectus_id(), sesion.getCompany_id() );
		
		Access access = new Access();
		
		access.setCompany_id(sesion.getCompany_id());
		access.setProspectus_id(sesion.getProspectus_id());
		access.setScreen_id(76);
		access.setPercentage(0);
		access.setWeb_browser(sesion.getNamebrawser());
		access.setWeb_browser_version(sesion.getVersionbrawser());
		access.setOp_system(sesion.getOsbrawser());
		access.setHorizontal_size(sesion.getBrowser_width());
		access.setVertical_size(sesion.getBrowser_height());
		access.setIpaddress(sesion.getIP_address_client());
		access.setUser_agent(sesion.getUser_agent());
		access.setDevice_info(sesion.getDevice_info());
		access.setUrl_access( sesion.getUrl_access() );
		access.setProspectus_id_coach(sesion.getCoachProspectus_id());
		
		access.setIpaddress(sesion.getIP_address_client());
		
		access.setAccess_datetime(new Date());
		
		access.setProspectus_id_coach (sesion.getCoachProspectus_id());
		access.setAccess_from		  (sesion.getAccess_from());
		access.setVersion_description (sesion.getVersion_description());
		
		accessService.add(access, true);
		
		//Registra en PRACCESS
	}
	
	private void generaURL( String prospectus_id ){
		
		// https://kubofinanciero.eflglobal.com/hostedPlayer.html?externalKey=MTIzNDU=&redirectURL=aHR0cHM6Ly9rdWJvZmluYW5jaWVyby5sZWFkcGFnZXMuY28vZWZsLWdyYWNpYXMv
		
		String url = "https://kubofinanciero.eflglobal.com/hostedPlayer.html?externalKey="  ;
		
		String encode = Utilities.decodeBase64( prospectus_id );
		
		System.out.println( "decodeBase64 " + prospectus_id +" : " + encode );
		
		url += encode;
		
		//System.out.println( "encodeBase64 " + encode +" : " +  Utilities.encodeBase64( encode ) );
		
		//url += Utilities.encodeBase64( prospectus_id );
		
		url_str_2 = "http://www.kubofinanciero.com/Kubo/Portal/efl2.xhtml?utm_source=EFL_PSYCHOMETRIC&utm_medium=PSYCHOMETRIC&prospectus_id=" + encode;
		
		String url_return = Utilities.decodeBase64( url_str_2 );
		
		url += "&redirectURL="+url_return;
				
		url_str_1 = url;
		
		System.out.println( "url:  " + url_str_1 );
		
	}

	public String getUrl_str_1() {
		return url_str_1;
	}

	public void setUrl_str_1(String url_str_1) {
		this.url_str_1 = url_str_1;
	}

	public String getUrl_redirec() {
		return url_redirec;
	}

	public void setUrl_redirec(String url_redirec) {
		this.url_redirec = url_redirec;
	}

	public String getUrl_str_2() {
		return url_str_2;
	}

	public void setUrl_str_2(String url_str_2) {
		this.url_str_2 = url_str_2;
	}
	
	private String decoderBase64( String word ){
		try{
			 BASE64Decoder decoder = new BASE64Decoder();
			String res = new String(decoder.decodeBuffer(word), "UTF-8");
		
		System.out.println("decoderBase64  '"+ word + "':" + res);
		
		return res;
		}catch(Exception e){
			e.printStackTrace();
			return "";
		}
		
	}
	
	
	private String getEncryptString(String str) {
		String res = "";
	    BASE64Encoder base64en = new BASE64Encoder();
	    try {
			
			res = base64en.encodeBuffer( str.getBytes() );
			
			System.out.println("encoderBase64  '"+ str + "':" + res);
			
	    } catch (Exception e) {
	        throw new RuntimeException(e);
	    }
	    
	    return res;
	    
	}

	public ScoringService getScoringservice() {
		return scoringservice;
	}

	public void setScoringservice(ScoringService scoringservice) {
		this.scoringservice = scoringservice;
	}

	public AccessService getAccessService() {
		return accessService;
	}

	public void setAccessService(AccessService accessService) {
		this.accessService = accessService;
	}
	 
	
}
